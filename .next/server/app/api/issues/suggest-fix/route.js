"use strict";(()=>{var e={};e.id=13,e.ids=[13],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},6048:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>m,patchFetch:()=>_,requestAsyncStorage:()=>p,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var s={};o.r(s),o.d(s,{POST:()=>g});var i=o(73278),n=o(45002),r=o(54877),a=o(41644),d=o(68420),u=o(27382),l=o(95013);async function g(e){let t=process.env.OPENAI_API_KEY;if(!t)return Response.json({suggestedFixes:[],message:"OPENAI_API_KEY is not set"},{status:200});try{let o;let s=await e.json(),i=Array.isArray(s.issues)?s.issues:[],n="string"==typeof s.revisionInstructions?s.revisionInstructions.trim():void 0,r="string"==typeof s.previousSuggestedFix?s.previousSuggestedFix:void 0,g=!!(n&&r&&1===i.length);if(0===i.length)return Response.json({suggestedFixes:[],agent:"solution"});let c="";if(process.env.DATABASE_URL)try{let e=await d.db.select().from(u.logs).orderBy((0,l.C)(u.logs.createdAt)).limit(25);e.length>0&&(c="\n\nPast solutions from the knowledge base (use these to inform your suggestions; when your suggestion aligns with a past solution that had a high developer rating, set agentConfidenceScore closer to 1.0):\n"+e.map(e=>`- title: ${e.title}
  description: ${e.description}
  severity: ${e.severity}
  suggestedFix: ${e.suggestedFix}
  developerRating: ${e.developerRating??"—"}`).join("\n"))}catch(e){console.error("suggest-fix: fetch logs error",e)}let p=(0,a.p)(),f=i.map(e=>`- recordingId: ${e.recordingId}
  category: ${e.posthogCategoryId} / ${e.posthogIssueTypeId}
  title: ${e.title}
  description: ${e.description}
  codeLocation: ${e.codeLocation}
  codeSnippetHint: ${e.codeSnippetHint??"(none)"}
  startUrl: ${e.startUrl??"(none)"}`).join("\n\n"),h=`You are a Solution Agent. You receive the output from an Issue Monitoring Agent: a list of issues (each with PostHog category, title, description, code location, and optional snippet hint). Your job is to suggest concrete fixes for each issue.

Use the codebase map only to align file paths and component names. Do not invent file contents. Suggest:
1. suggestedFix: step-by-step fix (e.g. add loading state, fix onClick handler, add error boundary, improve form validation). Be concrete and actionable.
2. Optionally codeEdits: array of { file, description, snippet } where snippet is a short code change (e.g. a few lines to add or change). Keep snippets minimal and accurate to the codebase map.
3. agentConfidenceScore: number from 0 to 1. Set higher (e.g. 0.8–1.0) when your suggestion is strongly supported by a similar past solution in the knowledge base with a high developer rating; set lower when you are inferring without a close match.
${c}

${p}

Output valid JSON only, no markdown:
{
  "suggestedFixes": [
    {
      "recordingId": "<id>",
      "title": "<same as input>",
      "suggestedFix": "<multiline step-by-step fix>",
      "codeLocation": "<same file path>",
      "codeEdits": [
        { "file": "<path>", "description": "<what to do>", "snippet": "<few lines of code or diff-style change>" }
      ],
      "agentConfidenceScore": 0.0
    }
  ]
}
Include one entry per input issue. codeEdits can be empty array if you only suggest high-level steps. agentConfidenceScore must be a number between 0 and 1.`,m=g?`The developer requested a revision for this issue.

Previous suggested fix:
${r}

Developer revision instructions:
${n}

Issue context:
${f}

Output a revised suggested fix in the same JSON format (suggestedFixes array with one object for recordingId ${i[0].recordingId}).`:`Issues from Issue Monitoring Agent (fix each):

${f}`,_=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:"gpt-4o-mini",messages:[{role:"system",content:h},{role:"user",content:m}],response_format:{type:"json_object"},max_completion_tokens:2500})});if(!_.ok){let e=await _.text();return console.error("OpenAI solution agent error:",_.status,e),Response.json({suggestedFixes:[],agent:"solution"},{status:200})}let y=await _.json(),v=y.choices?.[0]?.message?.content;if(!v)return Response.json({suggestedFixes:[],agent:"solution"});try{o=JSON.parse(v)}catch{return Response.json({suggestedFixes:[],agent:"solution"})}let x=Array.isArray(o.suggestedFixes)?o.suggestedFixes.filter(e=>null!=e&&"string"==typeof e.recordingId&&"string"==typeof e.title&&"string"==typeof e.suggestedFix&&"string"==typeof e.codeLocation):[];if(process.env.DATABASE_URL&&x.length>0)try{for(let e of x){let t="number"==typeof e.agentConfidenceScore&&e.agentConfidenceScore>=0&&e.agentConfidenceScore<=1?e.agentConfidenceScore:null;if(null==t)continue;let o=i.find(t=>t.recordingId===e.recordingId);o&&await d.db.insert(u.logs).values({recordingId:e.recordingId,title:e.title,description:o.description,severity:o.severity,suggestedFix:e.suggestedFix,agentConfidenceScore:String(t)})}}catch(e){console.error("suggest-fix: persist logs error",e)}return Response.json({suggestedFixes:x,agent:"solution"})}catch(e){return console.error("Solution agent error:",e),Response.json({suggestedFixes:[],agent:"solution"})}}let c=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/issues/suggest-fix/route",pathname:"/api/issues/suggest-fix",filename:"route",bundlePath:"app/api/issues/suggest-fix/route"},resolvedPagePath:"C:\\Users\\RISHAY\\Downloads\\bugScout Frontend\\app\\api\\issues\\suggest-fix\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:h}=c,m="/api/issues/suggest-fix/route";function _(){return(0,r.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},41644:(e,t,o)=>{o.d(t,{p:()=>r});var s=o(92048),i=o(55315);let n=null;function r(){let e=function(){if(n)return n;try{let e=(0,i.join)(process.cwd(),"CODEBASE_MAP.json"),t=(0,s.readFileSync)(e,"utf-8");return n=JSON.parse(t)}catch{return{files:[],fileToPurposeMap:{}}}}(),t=["Codebase map (use to suggest codeLocation and codeSnippetHint):",`Project: ${e.meta?.projectName??"Unknown"}`,""];return e.files?.length&&(t.push("Files (path -> role):"),e.files.forEach(e=>t.push(`  ${e.path} -> ${e.role}`))),e.fileToPurposeMap&&Object.keys(e.fileToPurposeMap).length>0&&(t.push(""),t.push("File purpose (path -> purpose):"),Object.entries(e.fileToPurposeMap).forEach(([e,o])=>t.push(`  ${e} -> ${o}`))),e.routing?.pages&&Object.keys(e.routing.pages).length>0&&(t.push(""),t.push("Routes (URL -> page/description):"),Object.entries(e.routing.pages).slice(0,30).forEach(([e,o])=>t.push(`  ${e} -> ${o}`))),t.join("\n")}},68420:(e,t,o)=>{o.d(t,{db:()=>a});var s=o(40546),i=o(92512),n=o(27382);let r=(0,s.qn)(process.env.DATABASE_URL),a=(0,i.tS)(r,{schema:n})},27382:(e,t,o)=>{o.r(t),o.d(t,{issueRevisions:()=>f,issues:()=>p,logs:()=>h,monitoring:()=>c,posthogEvents:()=>m});var s=o(61951),i=o(59397),n=o(39411),r=o(84006),a=o(70380),d=o(83204),u=o(10950),l=o(21305),g=o(67691);let c=(0,s.af)("monitoring",{id:(0,i.Vj)("id").primaryKey().defaultRandom(),recordingId:(0,n.fL)("recording_id").notNull(),distinctId:(0,n.fL)("distinct_id"),recordingDuration:(0,r._L)("recording_duration"),startTime:(0,a.AB)("start_time",{withTimezone:!0}),clickCount:(0,r._L)("click_count"),consoleErrorCount:(0,r._L)("console_error_count"),rageClickCount:(0,r._L)("rage_click_count"),deadClickCount:(0,r._L)("dead_click_count"),startUrl:(0,n.fL)("start_url"),payload:(0,d.JB)("payload"),createdAt:(0,a.AB)("created_at",{withTimezone:!0}).defaultNow().notNull()},e=>[(0,u.o9)("monitoring_recording_id_idx").on(e.recordingId)]),p=(0,s.af)("issues",{id:(0,i.Vj)("id").primaryKey().defaultRandom(),recordingId:(0,n.fL)("recording_id").notNull().unique(),posthogCategoryId:(0,n.fL)("posthog_category_id").notNull(),posthogIssueTypeId:(0,n.fL)("posthog_issue_type_id").notNull(),title:(0,n.fL)("title").notNull(),description:(0,n.fL)("description").notNull(),severity:(0,n.fL)("severity").notNull(),codeLocation:(0,n.fL)("code_location").notNull(),codeSnippetHint:(0,n.fL)("code_snippet_hint"),startUrl:(0,n.fL)("start_url"),suggestedFix:(0,n.fL)("suggested_fix"),status:(0,n.fL)("status").notNull().default("Unresolved"),approved:(0,l.O7)("approved").notNull().default(!1),approvedRating:(0,r._L)("approved_rating"),approvedAt:(0,a.AB)("approved_at",{withTimezone:!0}),createdAt:(0,a.AB)("created_at",{withTimezone:!0}).defaultNow().notNull(),updatedAt:(0,a.AB)("updated_at",{withTimezone:!0}).defaultNow().notNull()}),f=(0,s.af)("issue_revisions",{id:(0,i.Vj)("id").primaryKey().defaultRandom(),issueId:(0,i.Vj)("issue_id").notNull().references(()=>p.id,{onDelete:"cascade"}),instruction:(0,n.fL)("instruction").notNull(),suggestedFixAfter:(0,n.fL)("suggested_fix_after"),createdAt:(0,a.AB)("created_at",{withTimezone:!0}).defaultNow().notNull()}),h=(0,s.af)("logs",{id:(0,i.Vj)("id").primaryKey().defaultRandom(),issueId:(0,i.Vj)("issue_id").references(()=>p.id),recordingId:(0,n.fL)("recording_id").notNull(),title:(0,n.fL)("title").notNull(),description:(0,n.fL)("description").notNull(),severity:(0,n.fL)("severity").notNull(),suggestedFix:(0,n.fL)("suggested_fix").notNull(),developerRating:(0,r._L)("developer_rating"),agentConfidenceScore:(0,g.gH)("agent_confidence_score",{precision:3,scale:2}),createdAt:(0,a.AB)("created_at",{withTimezone:!0}).defaultNow().notNull()}),m=(0,s.af)("posthog_events",{id:(0,i.Vj)("id").primaryKey().defaultRandom(),posthogEventId:(0,n.fL)("posthog_event_id").notNull(),eventName:(0,n.fL)("event_name").notNull(),distinctId:(0,n.fL)("distinct_id"),timestamp:(0,a.AB)("timestamp",{withTimezone:!0}).notNull(),url:(0,n.fL)("url"),elementTag:(0,n.fL)("element_tag"),elementText:(0,n.fL)("element_text"),sessionId:(0,n.fL)("session_id"),properties:(0,d.JB)("properties"),createdAt:(0,a.AB)("created_at",{withTimezone:!0}).defaultNow().notNull()},e=>[(0,u.o9)("posthog_events_posthog_event_id_idx").on(e.posthogEventId)])}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),s=t.X(0,[379,321],()=>o(6048));module.exports=s})();